<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evidence Ples≈Ø - Tabulka</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }

        .container {
            max-width: 1900px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.2rem;
            background: linear-gradient(90deg, #00d4ff, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: #8892b0;
            margin-bottom: 25px;
            font-size: 1rem;
        }

        /* Panels */
        .panel {
            background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(124, 58, 237, 0.3);
        }

        .panel-title {
            color: #00d4ff;
            margin-bottom: 15px;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-title:hover {
            color: #7c3aed;
        }

        .panel-content {
            display: block;
        }

        .panel-content.collapsed {
            display: none;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }

        .setting-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .setting-item label {
            color: #9ca3af;
            font-size: 0.8rem;
        }

        .setting-item input {
            padding: 8px 10px;
            border-radius: 8px;
            border: 2px solid rgba(124, 58, 237, 0.3);
            background: rgba(31, 41, 55, 0.8);
            color: #fff;
            font-size: 0.9rem;
        }

        .setting-item input:focus {
            outline: none;
            border-color: #7c3aed;
        }

        /* Service manager */
        .service-manager {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .service-tag {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(124, 58, 237, 0.3);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.85rem;
        }

        .service-tag.no-workers {
            background: rgba(239, 68, 68, 0.2);
            border: 1px dashed rgba(239, 68, 68, 0.4);
        }

        .service-tag .remove-btn {
            background: rgba(239, 68, 68, 0.5);
            border: none;
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 11px;
        }

        .service-tag .remove-btn:hover {
            background: #ef4444;
        }

        .add-service-form {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .add-service-form input[type="text"] {
            padding: 6px 10px;
            border-radius: 8px;
            border: 2px solid rgba(124, 58, 237, 0.3);
            background: rgba(31, 41, 55, 0.8);
            color: #fff;
            width: 130px;
        }

        .add-service-form button {
            padding: 6px 14px;
            border-radius: 8px;
            border: none;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .add-service-form label {
            display: flex;
            align-items: center;
            gap: 4px;
            color: #9ca3af;
            font-size: 0.8rem;
        }

        .add-service-form input[type="checkbox"] {
            width: 14px;
            height: 14px;
        }

        .info-text {
            color: #6b7280;
            font-size: 0.75rem;
            margin-bottom: 10px;
        }

        /* Table */
        .table-container {
            background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
            border-radius: 14px;
            padding: 15px;
            overflow-x: auto;
            border: 1px solid rgba(124, 58, 237, 0.3);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        th {
            background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
            color: white;
            padding: 10px 6px;
            text-align: center;
            font-weight: 600;
            white-space: nowrap;
            font-size: 0.8rem;
        }

        th:first-child {
            border-radius: 8px 0 0 0;
        }

        th:last-child {
            border-radius: 0 8px 0 0;
        }

        td {
            padding: 8px 5px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        tr:hover td {
            background: rgba(124, 58, 237, 0.1);
        }

        td input[type="text"],
        td input[type="date"],
        td input[type="number"] {
            background: transparent;
            border: 1px solid transparent;
            color: #fff;
            padding: 5px;
            width: 100%;
            text-align: center;
            border-radius: 5px;
            font-size: 0.85rem;
        }

        td input:focus {
            outline: none;
            border-color: #7c3aed;
            background: rgba(124, 58, 237, 0.1);
        }

        td input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #7c3aed;
        }

        .small-input {
            width: 50px !important;
        }

        /* Badges */
        .day-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .day-so {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        .day-pa {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .day-ne {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .day-other {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }

        .event-vip {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #000;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 700;
        }

        .event-important {
            background: linear-gradient(135deg, #10b981, #059669);
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        .event-normal {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            padding: 3px 8px;
            border-radius: 10px;
        }

        .event-low {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            padding: 3px 8px;
            border-radius: 10px;
        }

        .money-positive {
            color: #22c55e;
            font-weight: 600;
        }

        .money-negative {
            color: #ef4444;
            font-weight: 600;
        }

        /* Worker count badges with color intensity */
        .workers-badge {
            padding: 4px 10px;
            border-radius: 10px;
            font-weight: 700;
            display: inline-block;
            min-width: 35px;
        }

        .workers-0 {
            background: rgba(34, 197, 94, 0.3);
            color: #22c55e;
        }

        .workers-1 {
            background: rgba(34, 197, 94, 0.4);
            color: #22c55e;
        }

        .workers-2 {
            background: rgba(250, 204, 21, 0.4);
            color: #facc15;
        }

        .workers-3 {
            background: rgba(249, 115, 22, 0.4);
            color: #f97316;
        }

        .workers-4 {
            background: rgba(239, 68, 68, 0.5);
            color: #ef4444;
        }

        .workers-5 {
            background: rgba(239, 68, 68, 0.7);
            color: #fca5a5;
        }

        .workers-6plus {
            background: rgba(220, 38, 38, 0.8);
            color: #fecaca;
        }

        /* Needed workers (remaining) */
        .needed-ok {
            background: rgba(34, 197, 94, 0.4);
            color: #22c55e;
        }

        .needed-some {
            background: rgba(250, 204, 21, 0.4);
            color: #facc15;
        }

        .needed-many {
            background: rgba(249, 115, 22, 0.5);
            color: #f97316;
        }

        .needed-critical {
            background: rgba(239, 68, 68, 0.6);
            color: #fca5a5;
        }

        .count-badge {
            background: rgba(124, 58, 237, 0.3);
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        .delete-btn {
            background: transparent;
            border: none;
            color: #ef4444;
            cursor: pointer;
            font-size: 1rem;
        }

        .delete-btn:hover {
            transform: scale(1.2);
        }

        .add-row-btn {
            background: transparent;
            border: 2px dashed rgba(124, 58, 237, 0.5);
            color: #7c3aed;
            padding: 8px;
            width: 100%;
            cursor: pointer;
            margin-top: 8px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .add-row-btn:hover {
            background: rgba(124, 58, 237, 0.1);
            border-color: #7c3aed;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .summary-card {
            background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(124, 58, 237, 0.3);
        }

        .summary-card h3 {
            color: #8892b0;
            font-size: 0.75rem;
            margin-bottom: 6px;
            text-transform: uppercase;
        }

        .summary-card .value {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .summary-card.profit .value {
            color: #22c55e;
        }

        .summary-card.cost .value {
            color: #ef4444;
        }

        .summary-card.net .value {
            color: #00d4ff;
        }

        .summary-card.workers .value {
            color: #f59e0b;
        }

        /* Buttons */
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #7c3aed, #5b21b6);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        /* Tooltip for headers */
        th[title] {
            cursor: help;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üìã Evidence Ples≈Ø 2026</h1>
        <p class="subtitle">Automatick√° tabulka s v√Ωpoƒçty a spr√°vou lid√≠</p>

        <!-- Settings Panel -->
        <div class="panel">
            <h2 class="panel-title" onclick="togglePanel('settings')">‚öôÔ∏è Nastaven√≠</h2>
            <div class="panel-content" id="settings">
                <div class="settings-grid">
                    <div class="setting-item">
                        <label>üí∞ V√Ωplata/osoba (Kƒç)</label>
                        <input type="number" id="workerPay" value="1500" onchange="recalculateAll()">
                    </div>
                    <div class="setting-item">
                        <label>‚≠ê Limit VIP (Kƒç)</label>
                        <input type="number" id="vipLimit" value="25000" onchange="recalculateAll()">
                    </div>
                    <div class="setting-item">
                        <label>üî• Limit d≈Øle≈æit√© (Kƒç)</label>
                        <input type="number" id="importantLimit" value="15000" onchange="recalculateAll()">
                    </div>
                    <div class="setting-item">
                        <label>üìå Limit norm√°ln√≠ (Kƒç)</label>
                        <input type="number" id="normalLimit" value="8000" onchange="recalculateAll()">
                    </div>
                </div>
            </div>
        </div>

        <!-- Service Columns Manager -->
        <div class="panel">
            <h2 class="panel-title" onclick="togglePanel('services')">üì¶ Spr√°va sloupc≈Ø slu≈æeb</h2>
            <div class="panel-content" id="services">
                <p class="info-text">‚ùå = odebrat sloupec | Slu≈æby bez "poƒç√≠tat lidi" neovliv≈àuj√≠ poƒçet pracovn√≠k≈Ø</p>
                <div class="service-manager" id="serviceList"></div>
                <div class="add-service-form">
                    <input type="text" id="newServiceName" placeholder="N√°zev slu≈æby...">
                    <label><input type="checkbox" id="newServiceCountWorkers" checked> Poƒç√≠tat lidi</label>
                    <button onclick="addServiceColumn()">‚ûï P≈ôidat</button>
                </div>
            </div>
        </div>

        <!-- Main Table -->
        <div class="table-container">
            <table id="eventTable">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
            <button class="add-row-btn" onclick="addRow()">‚ûï P≈ôidat nov√Ω ples</button>
        </div>

        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="summary-card profit">
                <h3>üí∞ Hrub√Ω v√Ωdƒõlek</h3>
                <div class="value" id="totalGross">0 Kƒç</div>
            </div>
            <div class="summary-card cost">
                <h3>üí∏ N√°klady na lidi</h3>
                <div class="value" id="totalCost">0 Kƒç</div>
            </div>
            <div class="summary-card net">
                <h3>üíé ƒåist√Ω zisk</h3>
                <div class="value" id="totalNet">0 Kƒç</div>
            </div>
            <div class="summary-card workers">
                <h3>üë• Celkem pot≈ôeba</h3>
                <div class="value" id="totalNeeded">0 lid√≠</div>
            </div>
        </div>

        <!-- Buttons -->
        <div class="btn-group">
            <button class="btn btn-primary" onclick="exportToCSV()">üì• St√°hnout CSV</button>
            <button class="btn btn-success" onclick="saveData()">üíæ Ulo≈æit</button>
        </div>
    </div>

    <script>
        // Service columns configuration
        let serviceColumns = [
            { id: 'video', name: 'Video', icon: 'üé¨', countWorkers: false },
            { id: 'foto1', name: 'Fotobudka', icon: 'üì∏', countWorkers: true },
            { id: 'foto2', name: 'Fotobudka 2', icon: 'üì∏', countWorkers: true },
            { id: 'r360', name: '360', icon: 'üîÑ', countWorkers: true }
        ];

        // Event data - now includes: confirmed (domluveno), extraWorkers (extra lidi nav√≠c)
        let events = [
            { date: '2026-01-10', name: 'Jasenn√° Hasiƒçsk√Ω?', services: { video: true, foto1: true, foto2: false, r360: false }, pausal: '', vydelek: 18000, confirmed: 0, extraWorkers: 0 },
            { date: '2026-01-23', name: 'Nov√° Paka', services: { video: false, foto1: true, foto2: false, r360: false }, pausal: '', vydelek: 6500, confirmed: 0, extraWorkers: 0 },
            { date: '2026-01-24', name: 'ƒåerven√Ω Kostelec', services: { video: false, foto1: true, foto2: false, r360: false }, pausal: '', vydelek: 6500, confirmed: 1, extraWorkers: 0 },
            { date: '2026-01-30', name: 'Skuteƒç', services: { video: false, foto1: true, foto2: false, r360: false }, pausal: '', vydelek: 9600, confirmed: 0, extraWorkers: 0 },
            { date: '2026-01-31', name: 'Cestovatelsk√Ω Letohrad', services: { video: false, foto1: true, foto2: false, r360: false }, pausal: '', vydelek: 15000, confirmed: 0, extraWorkers: 0 },
            { date: '2026-02-06', name: 'Holice Pardubice afina', services: { video: false, foto1: true, foto2: false, r360: false }, pausal: '', vydelek: 30000, confirmed: 2, extraWorkers: 1 },
            { date: '2026-02-06', name: 'Kojet√≠n (L. Bartl)', services: { video: false, foto1: true, foto2: false, r360: false }, pausal: '', vydelek: 3500, confirmed: 0, extraWorkers: 0 },
            { date: '2026-02-07', name: 'Trutnov UFFO (Gples)', services: { video: false, foto1: false, foto2: false, r360: false }, pausal: '', vydelek: 7000, confirmed: 0, extraWorkers: 0 },
            { date: '2026-02-13', name: 'Hradec Kr√°lov√© MOOD', services: { video: true, foto1: true, foto2: false, r360: false }, pausal: '', vydelek: 17500, confirmed: 0, extraWorkers: 0 },
            { date: '2026-02-26', name: 'Hradec Kr√°lov√© Aldis', services: { video: false, foto1: true, foto2: false, r360: false }, pausal: '', vydelek: 20000, confirmed: 0, extraWorkers: 0 },
            { date: '2026-02-27', name: 'Svƒõtl√° nad S√°zavou', services: { video: false, foto1: true, foto2: false, r360: false }, pausal: '', vydelek: 10000, confirmed: 0, extraWorkers: 0 },
            { date: '2026-02-27', name: 'Jablonec nad Nisou', services: { video: true, foto1: true, foto2: false, r360: false }, pausal: '', vydelek: 6500, confirmed: 1, extraWorkers: 0 },
            { date: '2026-02-28', name: 'Dv≈Ør kr√°lov√©', services: { video: false, foto1: true, foto2: false, r360: false }, pausal: '', vydelek: 10000, confirmed: 0, extraWorkers: 0 },
            { date: '2026-03-06', name: 'Juta Ples', services: { video: false, foto1: true, foto2: false, r360: false }, pausal: '', vydelek: 13000, confirmed: 0, extraWorkers: 0 },
            { date: '2026-03-20', name: 'Hlu≈°ice', services: { video: false, foto1: true, foto2: false, r360: false }, pausal: '', vydelek: 6000, confirmed: 0, extraWorkers: 0 },
            { date: '2026-03-14', name: 'B√≠l√° T≈ôeme≈°n√°', services: { video: false, foto1: true, foto2: false, r360: false }, pausal: '5000+30/ks', vydelek: 7000, confirmed: 0, extraWorkers: 0 },
            { date: '2026-03-27', name: 'Hlinsko', services: { video: false, foto1: true, foto2: false, r360: false }, pausal: '', vydelek: 10000, confirmed: 0, extraWorkers: 0 },
        ];

        const dayShort = ['Ne', 'Po', '√öt', 'St', 'ƒåt', 'P√°', 'So'];

        function togglePanel(id) {
            document.getElementById(id).classList.toggle('collapsed');
        }

        function getDayClass(dayIndex) {
            if (dayIndex === 6) return 'day-so';
            if (dayIndex === 5) return 'day-pa';
            if (dayIndex === 0) return 'day-ne';
            return 'day-other';
        }

        function getEventType(vydelek) {
            const vip = parseInt(document.getElementById('vipLimit').value) || 25000;
            const imp = parseInt(document.getElementById('importantLimit').value) || 15000;
            const norm = parseInt(document.getElementById('normalLimit').value) || 8000;
            if (vydelek >= vip) return { class: 'event-vip', name: '‚≠ê VIP' };
            if (vydelek >= imp) return { class: 'event-important', name: 'üî• D≈Øle≈æit√°' };
            if (vydelek >= norm) return { class: 'event-normal', name: 'üìå Norm√°ln√≠' };
            return { class: 'event-low', name: 'üìã Men≈°√≠' };
        }

        function formatMoney(amount) {
            return new Intl.NumberFormat('cs-CZ').format(amount) + ' Kƒç';
        }

        // Calculate required workers from services
        function calculateBaseWorkers(services) {
            let count = 0;
            serviceColumns.forEach(col => {
                if (col.countWorkers && services[col.id]) count++;
            });
            return count;
        }

        // Total workers = base + extra
        function calculateTotalWorkers(event) {
            return calculateBaseWorkers(event.services) + (event.extraWorkers || 0);
        }

        // Needed = total - confirmed
        function calculateNeededWorkers(event) {
            const total = calculateTotalWorkers(event);
            const confirmed = event.confirmed || 0;
            return Math.max(0, total - confirmed);
        }

        function calculateServiceCount(services) {
            let count = 0;
            serviceColumns.forEach(col => {
                if (services[col.id]) count++;
            });
            return count;
        }

        // Get color class for worker count
        function getWorkersClass(count) {
            if (count === 0) return 'workers-0';
            if (count === 1) return 'workers-1';
            if (count === 2) return 'workers-2';
            if (count === 3) return 'workers-3';
            if (count === 4) return 'workers-4';
            if (count === 5) return 'workers-5';
            return 'workers-6plus';
        }

        // Get color class for needed workers
        function getNeededClass(needed) {
            if (needed === 0) return 'needed-ok';
            if (needed === 1) return 'needed-some';
            if (needed <= 2) return 'needed-many';
            return 'needed-critical';
        }

        // Render service columns manager
        function renderServiceManager() {
            const container = document.getElementById('serviceList');
            container.innerHTML = serviceColumns.map(col => `
                <div class="service-tag ${col.countWorkers ? '' : 'no-workers'}">
                    ${col.icon} ${col.name}
                    ${col.countWorkers ? '' : '<small>(bez lid√≠)</small>'}
                    <button class="remove-btn" onclick="removeServiceColumn('${col.id}')">√ó</button>
                </div>
            `).join('');
        }

        function addServiceColumn() {
            const nameInput = document.getElementById('newServiceName');
            const countWorkersInput = document.getElementById('newServiceCountWorkers');
            const name = nameInput.value.trim();
            if (!name) { alert('Zadej n√°zev slu≈æby!'); return; }
            const id = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
            if (serviceColumns.find(c => c.id === id)) { alert('Slu≈æba ji≈æ existuje!'); return; }
            serviceColumns.push({ id, name, icon: 'üì¶', countWorkers: countWorkersInput.checked });
            events.forEach(e => e.services[id] = false);
            nameInput.value = '';
            countWorkersInput.checked = true;
            renderAll();
        }

        function removeServiceColumn(id) {
            if (!confirm(`Odstranit sloupec "${serviceColumns.find(c => c.id === id)?.name}"?`)) return;
            serviceColumns = serviceColumns.filter(c => c.id !== id);
            events.forEach(e => delete e.services[id]);
            renderAll();
        }

        // Render table header
        function renderHeader() {
            const thead = document.getElementById('tableHead');
            let html = '<tr>';
            html += '<th>üìÖ Datum</th>';
            html += '<th>üìÜ</th>';
            html += '<th>üé≠ N√°zev</th>';
            serviceColumns.forEach(col => {
                const title = col.countWorkers ? 'Poƒç√≠t√° se do lid√≠' : 'Nepoƒç√≠t√° se do lid√≠';
                html += `<th title="${title}">${col.icon}</th>`;
            });
            html += '<th>üíµ Pau≈°√°l</th>';
            html += '<th>üî¢</th>';
            html += '<th>üí∞ V√Ωdƒõlek</th>';
            html += '<th title="Celkem pot≈ôeba lid√≠ (automaticky + extra)">üë• Celkem</th>';
            html += '<th title="Kolik lid√≠ m√°≈° domluveno">‚úÖ Domluveno</th>';
            html += '<th title="Kolik lid√≠ je≈°tƒõ pot≈ôebuje≈° sehnat">‚ö†Ô∏è Chyb√≠</th>';
            html += '<th title="Extra lid√© nav√≠c (tvoje rozhodnut√≠)">‚ûï Extra</th>';
            html += '<th>‚ö°</th>';
            html += '<th>üí∏ Cena</th>';
            html += '<th>üíé Zisk</th>';
            html += '<th>üóëÔ∏è</th>';
            html += '</tr>';
            thead.innerHTML = html;
        }

        // Render table body
        function renderBody() {
            const tbody = document.getElementById('tableBody');
            const workerPay = parseInt(document.getElementById('workerPay').value) || 1500;

            tbody.innerHTML = events.map((event, idx) => {
                const date = event.date;
                let dayBadge = '';
                if (date) {
                    const d = new Date(date);
                    dayBadge = `<span class="day-badge ${getDayClass(d.getDay())}">${dayShort[d.getDay()]}</span>`;
                }

                const serviceCount = calculateServiceCount(event.services);
                const totalWorkers = calculateTotalWorkers(event);
                const neededWorkers = calculateNeededWorkers(event);
                const workerCost = totalWorkers * workerPay;
                const netProfit = event.vydelek - workerCost;
                const eventType = getEventType(event.vydelek);
                const confirmed = event.confirmed || 0;
                const extra = event.extraWorkers || 0;

                let row = '<tr>';
                row += `<td><input type="date" value="${date}" onchange="updateEvent(${idx}, 'date', this.value)"></td>`;
                row += `<td>${dayBadge}</td>`;
                row += `<td><input type="text" value="${event.name}" onchange="updateEvent(${idx}, 'name', this.value)"></td>`;

                serviceColumns.forEach(col => {
                    const checked = event.services[col.id] ? 'checked' : '';
                    row += `<td><input type="checkbox" ${checked} onchange="updateService(${idx}, '${col.id}', this.checked)" title="${col.name}"></td>`;
                });

                row += `<td><input type="text" value="${event.pausal}" onchange="updateEvent(${idx}, 'pausal', this.value)" class="small-input"></td>`;
                row += `<td><span class="count-badge">${serviceCount}</span></td>`;
                row += `<td><input type="number" value="${event.vydelek}" onchange="updateEvent(${idx}, 'vydelek', parseInt(this.value)||0)" style="color:#22c55e;width:70px"></td>`;

                // Total workers with color
                row += `<td><span class="workers-badge ${getWorkersClass(totalWorkers)}">${totalWorkers}</span></td>`;

                // Confirmed input
                row += `<td><input type="number" value="${confirmed}" min="0" max="${totalWorkers}" onchange="updateEvent(${idx}, 'confirmed', Math.max(0,parseInt(this.value)||0))" class="small-input" style="color:#22c55e"></td>`;

                // Needed with color
                row += `<td><span class="workers-badge ${getNeededClass(neededWorkers)}">${neededWorkers}</span></td>`;

                // Extra workers input
                row += `<td><input type="number" value="${extra}" min="0" onchange="updateEvent(${idx}, 'extraWorkers', Math.max(0,parseInt(this.value)||0))" class="small-input" style="color:#f59e0b"></td>`;

                row += `<td><span class="${eventType.class}">${eventType.name}</span></td>`;
                row += `<td class="money-negative">${formatMoney(workerCost)}</td>`;
                row += `<td class="${netProfit >= 0 ? 'money-positive' : 'money-negative'}">${formatMoney(netProfit)}</td>`;
                row += `<td><button class="delete-btn" onclick="deleteEvent(${idx})">üóëÔ∏è</button></td>`;
                row += '</tr>';
                return row;
            }).join('');
        }

        function updateEvent(idx, field, value) {
            events[idx][field] = value;
            renderBody();
            updateTotals();
        }

        function updateService(idx, serviceId, checked) {
            events[idx].services[serviceId] = checked;
            renderBody();
            updateTotals();
        }

        function deleteEvent(idx) {
            events.splice(idx, 1);
            renderAll();
        }

        function addRow() {
            const newEvent = { date: '', name: '', services: {}, pausal: '', vydelek: 0, confirmed: 0, extraWorkers: 0 };
            serviceColumns.forEach(col => newEvent.services[col.id] = false);
            events.push(newEvent);
            renderBody();
        }

        function updateTotals() {
            const workerPay = parseInt(document.getElementById('workerPay').value) || 1500;
            let totalGross = 0, totalCost = 0, totalNeeded = 0;

            events.forEach(event => {
                const total = calculateTotalWorkers(event);
                const needed = calculateNeededWorkers(event);
                totalGross += event.vydelek || 0;
                totalCost += total * workerPay;
                totalNeeded += needed;
            });

            document.getElementById('totalGross').textContent = formatMoney(totalGross);
            document.getElementById('totalCost').textContent = formatMoney(totalCost);
            document.getElementById('totalNet').textContent = formatMoney(totalGross - totalCost);
            document.getElementById('totalNeeded').textContent = totalNeeded + ' lid√≠';
        }

        function recalculateAll() { renderBody(); updateTotals(); }
        function renderAll() { renderServiceManager(); renderHeader(); renderBody(); updateTotals(); }

        function exportToCSV() {
            const workerPay = parseInt(document.getElementById('workerPay').value) || 1500;
            let headers = ['Datum', 'Den', 'N√°zev'];
            serviceColumns.forEach(col => headers.push(col.name));
            headers.push('Pau≈°√°l', 'Slu≈æby', 'V√Ωdƒõlek', 'Celkem lid√≠', 'Domluveno', 'Chyb√≠', 'Extra', 'Typ', 'Cena lid√≠', 'ƒåist√Ω zisk');
            let csv = headers.join(';') + '\n';

            events.forEach(event => {
                const d = event.date ? new Date(event.date) : null;
                const day = d ? dayShort[d.getDay()] : '';
                const total = calculateTotalWorkers(event);
                const needed = calculateNeededWorkers(event);
                const workerCost = total * workerPay;
                const net = event.vydelek - workerCost;
                const type = getEventType(event.vydelek).name.replace(/[‚≠êüî•üìåüìã]\s*/g, '');
                let row = [event.date, day, event.name];
                serviceColumns.forEach(col => row.push(event.services[col.id] ? 'ANO' : 'NE'));
                row.push(event.pausal, calculateServiceCount(event.services), event.vydelek, total, event.confirmed || 0, needed, event.extraWorkers || 0, type, workerCost, net);
                csv += row.join(';') + '\n';
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'evidence_plesu_2026.csv';
            link.click();
        }

        function saveData() {
            localStorage.setItem('plesyData', JSON.stringify({ serviceColumns, events }));
            alert('Data ulo≈æena!');
        }

        function loadData() {
            const saved = localStorage.getItem('plesyData');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (data.serviceColumns) serviceColumns = data.serviceColumns;
                    if (data.events) events = data.events;
                } catch (e) { }
            }
        }

        document.addEventListener('DOMContentLoaded', () => { loadData(); renderAll(); });
    </script>
</body>

</html>